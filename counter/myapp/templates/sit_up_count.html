<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Counter dan Waktu Mundur</title>
  <link rel="stylesheet" href="../static/css/home.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> <!-- Hubungkan jQuery -->
</head>
<body>
    <div class="mode-title">
        <h1>Mode Sit-up</h1>
    </div>
    <div class="container">
        <div class="counters">
            <div class="counter">
                <h2>Gerakan Benar</h2>
                <p id="correctCounter">0</p>
            </div>
            <div class="counter">
                <h2>Gerakan Salah</h2>
                <p id="wrongCounter">0</p>
            </div>
        </div>
        <div class="divider">
            <div class="timer">
                <h2>Waktu Mundur</h2>
                <p id="countdown">01:00</p> <!-- Waktu mundur default 1 menit -->
                <div class="buttons">
                    <button class="start-btn" onclick="startTimer()">Start</button> <!-- Memulai waktu mundur dan memulai menerima data -->
                    <button class="restart-btn" onclick="restartTimer()">Restart</button>
                    <button class="stop-btn" onclick="stopReceivingData()">Stop</button>
                </div>
            </div>
        </div>
    </div>
    <button class="back-btn" onclick="goToMode()">Back</button>

    <script>
        var timerInterval; // Variabel untuk menyimpan interval waktu mundur
        var counterInterval; // Variabel untuk menyimpan interval pengiriman data 'counter'
        var counter = 0; // Variabel untuk menyimpan nilai counter
        var countdownTime = 60; // Waktu mundur dalam detik
        var countdownElement = document.getElementById('countdown');
        var timerRunning = false; // Flag untuk menandakan apakah timer sedang berjalan

        function startTimer() {
            if (!timerRunning) {
                timerRunning = true;
                clearInterval(counterInterval); // Hentikan interval pengambilan data 'counter' jika sebelumnya sudah berjalan
                clearInterval(timerInterval); // Hentikan interval waktu mundur jika sebelumnya sudah berjalan

                // Mulai interval untuk mengurangi waktu mundur setiap detik
                timerInterval = setInterval(function() {
                    var minutes = Math.floor(countdownTime / 60);
                    var seconds = countdownTime % 60;
                    countdownElement.innerText = (minutes < 10 ? '0' : '') + minutes + ':' + (seconds < 10 ? '0' : '') + seconds;

                    if (countdownTime <= 0) {
                        clearInterval(timerInterval); // Hentikan interval jika waktu mundur habis
                        stopReceivingData(); // Hentikan penerimaan data dari views.py
                    } else {
                        countdownTime--;
                        if (countdownTime === 59) { // Mulai menerima data 'counter' dari views.py hanya saat waktu mundur dimulai
                            startReceivingData();
                        }
                    }
                }, 1000);
            }
        }

        function startReceivingData() {
            // Mulai mengambil data 'counter' dari views.py menggunakan AJAX setiap detik
            counterInterval = setInterval(function() {
                $.ajax({
                    url: '/get-counter',
                    type: 'GET',
                    success: function(data) {
                        if (data.data === 1) {
                            counter++;
                            $('#correctCounter').text(counter);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Error:', error);
                    }
                });
            }, 1000); // Ambil data setiap detik
        }

        function stopReceivingData() {
            clearInterval(counterInterval); // Hentikan interval pengambilan data 'counter' dari views.py
            clearInterval(timerInterval); // Hentikan interval waktu mundur jika tombol "Stop" ditekan
            timerRunning = false;
        }

        function restartTimer() {
            stopReceivingData(); // Hentikan semua interval
            counter = 0; // Reset nilai counter
            countdownTime = 60; // Reset waktu mundur ke 1 menit
            $('#correctCounter').text(counter); // Reset tampilan counter benar
            $('#wrongCounter').text(0); // Reset tampilan counter salah, jika diperlukan
            countdownElement.innerText = "01:00"; // Reset tampilan waktu mundur ke 1 menit
            timerRunning = false; // Set flag timerRunning ke false
        }

        function goToMode() {
            window.location.href = '/mode'; // Redirect ke halaman home
        }
    </script>
</body>
</html>
